---
title: 代码重构回顾
date: 2019-02-04 19:57:53
tags:
---
## 一、原始代码问题

##### 1. 代码缺乏分层结构
(1) 业务逻辑完全在Controller层中
(2) 在Controller层直接执行SQL
(3) 在Model层接收请求参数
##### 2.  安全性缺失
(1) 使用请求参数直接拼接SQL
(2) 用户数据未经处理直接进入数据库
##### 3. 可读性差
(1) 单个方法数百行
(2) 有大量功能相近的重复性代码
(3) 滥用静态方法
(4) 通过接收参数，使用call_func动态调用业务方法
(5) 存在非常复杂的SQL
##### 4. 继承混乱
存在多个类似的基类，www/api/m站交叉继承


## 二、分步进行重构

##### 1. 构建 controller-service-business-model 分层结构
controller - 参数接收，调用srv、biz层业务代码，返回数据
service    - 调用各个业务的biz完成业务数据收集和格式拼接
business   - 按业务模块划分，每个biz独立负责业务逻辑，接受参数并返回数据
model      - 只进行数据查询

具体分为两步：
1. 事先为biz构建数个主要业务方法，尽可能迁移拆分原集中在controller中的业务逻辑到这些方法中，如果必须增加方法时额外记录，确保biz中的方法内聚性较高，尽量避免重复逻辑。
2. 清理biz层、model层接收请求参数，上步中仅拆分代码，会导致部分使用了请求参数_REQUEST、_GET等的方法被划分到biz、model中。清理代码使参数改为从上层后获取传入biz、model层

同时应当制定流程规范确保新增代码满足：
- 业务逻辑集中在biz、每个biz属于一种业务，业务间相对独立，使每个biz高内聚，biz之间低耦合
- 不允许跨层调用：ctrl、srv层不允许操作db、只能调用不同biz再拼装数据以实现业务逻辑
- 不允许跨模块调用：每个biz模块不允许调用其他模块的model，再次确保每块业务逻辑独立

难点：
从多处业务代码中抽取公共方法需要经验，抽取的公共方法覆盖的业务较少则未起到提取公共方法的目的，覆盖过多会使公共方法过于抽象、缺少共有逻辑。
并且需要熟悉业务逻辑，抽取过程中完全改变了原有结构，只能通过接口测试和业务测试验证。

另外在请求参数清理过程中，由于底层多数是通用方法，一个方法可能在srv、ctrl层被多次调用，不需要每处调用都传入请求参数，根据业务仅在必要时传入。根据业务需要选择作为可选参数或是封装在数组中传入。

另外需要说明，Model层的定位一般有两种：
(1) 数据逻辑：调用Model底层相应方法实现不同增删改查逻辑。Model不对应数据表，仅提供操作方法。输入/输出数据均通过参数/返回值进行操作
(2) 数据对象：Model对应数据表，即ActiveRecord的使用方式。输入/输出数据均通过Model对象属性访问
前者代码风格更偏向于面向过程，后者代码风格偏向于面向对象，实际在使用中两种方式均有使用。

##### 2. 降低前台SQL复杂程度，使用统一方法代替拼接SQL
安全性问题在MVC分层清晰、SQL采用参数绑定后已经基本解决，但是model层DB查询的方式不统一，比如大多数使用Yii的$db->createCommand方式直接写SQL，少数使用Query等封装，可读性和复用性较差。

前台代码严格禁止连表查询，额外设置ElasticSearch服务，提前将数据导入ES索引中，需要连表查询时改为从ES索引中查询数据。ElasticSearch服务可以以较好的性能和较低的改造难度兼容原有的连表查询业务逻辑。

##### 3. 通过重构增加代码可读性
替换部分非必要的静态方式为非静态方法，工具类适合使用静态方法
尽量避免使用用户参数进行call_func，写清判断条件，使调用逻辑明确
需要连表时全部走elasticsearch查询

##### 4. 每个站点统一继承的基类
明确基类职责，合并类似功能的基类统一继承：
- controller - 获取请求参数，正常返回/异常返回（包括HTML和Json），接口调用统计，接口参数基础
- service - 签名参数校验
- business - 获取Redis连接。Redis在业务上主要是缓存使用，但应当视同数据库，仅在biz层进行操作
- model - model基类分为组件级基类和业务级基类：
组件级基类：数据操作基础字段校验，在Yii DAO基础上封装单条/多条增删改查方法，读写分离支持
业务级基类：根据条件数组操作单条多条数据，接收参数、返回数据格式业务友好

## 三、重构结果
在重构前代码已经被业务研发广为诟病，原有基本处于无法维护的状态，新增业务功能只能另外新增方法，代码复制粘贴现象严重，无论是开发还是测试影响范围不可控。重构后业务代码分层清晰、模块上下级调用较为合理，为后续docker服务化、数据库无用表、无用字段清理打下基础。